<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Alumnos - Base de Datos Escolar</title>
    <style>
        /* --- ESTILOS GENERALES DE LA APP --- */
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --bg: #f8fafc;
            --text: #334155;
            --border: #cbd5e1;
            --success: #10b981;
            --danger: #ef4444;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border); }
        
        h1 { color: var(--primary); text-align: center; margin-bottom: 5px; }
        h2 { font-size: 1.2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Search Bar (Bot√≥n Azul) */
        .search-bar { display: flex; gap: 10px; }
        .search-bar input { flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1.1rem; }
        .search-bar button { padding: 0 25px; font-size: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; width: auto; }
        .search-bar button:hover { background: var(--primary-dark); }

        /* Results List */
        #resultsList { margin-top: 15px; }
        .result-item { padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; background: #fff; transition: all 0.2s; border-left: 5px solid var(--border); }
        .result-item:hover { border-left-color: var(--primary); transform: translateX(5px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .result-header { display: flex; justify-content: space-between; align-items: center; }
        .cct-badge { background: #e2e8f0; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        .turno-badge { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; }
        
        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .full-width { grid-column: 1 / -1; }
        
        label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 5px; }
        
        /* Inputs Generales */
        input { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; }
        input:focus { outline: 2px solid var(--primary-light); border-color: transparent; }
        
        input[readonly] { background-color: #f1f5f9; color: #94a3b8; border: none; font-weight: 500; }
        input.locked-field { background-color: #e2e8f0; color: #64748b; border: 1px solid #cbd5e1; cursor: not-allowed; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
        
        .section-title { grid-column: 1/-1; color: var(--primary); font-weight: bold; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.8rem; }

        .actions { margin-top: 25px; text-align: right; border-top: 1px solid var(--border); padding-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Bot√≥n Guardar */
        .btn-save { background: var(--success); padding: 12px 30px; font-size: 1.1rem; border: none; color: white; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-save:hover:not(:disabled) { background: #059669; }
        
        /* Estilo del Bot√≥n cuando est√° DESHABILITADO */
        .btn-save:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }

        /* Bot√≥n Salir */
        .btn-logout { background: var(--danger); padding: 12px 30px; font-size: 1.1rem; border: none; color: white; border-radius: 8px; cursor: pointer; }
        .btn-logout:hover { background: #dc2626; }

        #formSection.disabled { opacity: 0.5; pointer-events: none; filter: blur(1px); }

        #toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000; }
        #toast.show { opacity: 1; }
        #toast.success { background: var(--success); }
        #toast.error { background: #ef4444; }

        /* --- ESTILOS ESPEC√çFICOS DEL LOGIN --- */
        #login-view { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            /* üî• AQU√ç PONES LA IMAGEN DE FONDO */
            background: url('particulares.jpg') no-repeat center center fixed;
            background-size: cover; 
            
            display: flex; justify-content: center; align-items: center; z-index: 5000; 
        }
        
        /* Capa oscura semitransparente para que se lea el login sobre la imagen */
        #login-view::before {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }

        .login-container { background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; position: relative; z-index: 1; }
        
        .login-container h2 { color: #802434; margin: 0 0 20px 0; border: none; }
        
        #login-view input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #login-view button { width: 100%; padding: 12px; background: #802434; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #login-view button:hover { background: #5e1a28; }
        
        .error-message { color: #d32f2f; margin-top: 15px; font-weight: bold; word-break: break-word; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- ================= VISTA LOGIN ================= -->
    <div id="login-view">
      <div class="login-container">
        <h2>Acceso Restringido</h2>
        <input type="text" id="username" placeholder="Usuario" autocomplete="off">
        <input type="password" id="password" placeholder="Contrase√±a" autocomplete="off">
        <button onclick="checkLogin()">Iniciar Sesi√≥n</button>
        <div id="login-error" class="error-message"></div>
      </div>
    </div>

    <!-- ================= VISTA DE LA APLICACI√ìN ================= -->
    <div id="app-view" class="hidden">
        <div class="container">
            <header>
                <h1>Registro de Alumnos por Escuela</h1>
                <p style="text-align: center; color: #64748b;">Complete los datos faltantes. Los campos ya capturados se bloquear√°n.</p>
            </header>

            <!-- B√öSQUEDA -->
            <div class="card">
                <h2>1. Buscar Escuela</h2>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Escriba la Clave CCT (ej: 31PPR...)" onkeypress="if(event.key === 'Enter') searchSchool()">
                    <button onclick="searchSchool()">Buscar</button>
                </div>
                <div id="resultsList"></div>
            </div>

            <!-- FORMULARIO DE CAPTURA -->
            <div class="card disabled" id="formSection">
                <h2>2. Datos de la Escuela (Referencia)</h2>
                <form id="captureForm" onsubmit="event.preventDefault(); saveData();">
                    <input type="hidden" id="rowIndex">

                    <div class="form-grid">
                        <!-- CAMPOS DE SOLO LECTURA (REFERENCIA) -->
                        <div class="section-title">Informaci√≥n Identificatoria</div>
                        
                        <div><label>NUM</label><input type="text" id="disp_num" readonly></div>
                        <div><label>CLAVE C.C.T.</label><input type="text" id="disp_cct" readonly></div>
                        <div class="full-width"><label>NOMBRE ESCUELA</label><input type="text" id="disp_nombre" readonly></div>
                        <div><label>NIVEL</label><input type="text" id="disp_nivel" readonly></div>
                        <div><label>TURNO</label><input type="text" id="disp_turno" readonly style="font-weight: bold; color: #991b1b;"></div>
                        
                        <div class="section-title">Ubicaci√≥n y Contacto</div>
                        
                        <div class="full-width"><label>MUNICIPIO</label><input type="text" id="disp_municipio" readonly></div>
                        <div class="full-width"><label>LOCALIDAD</label><input type="text" id="disp_localidad" readonly></div>
                        <div class="full-width"><label>DIRECCION</label><input type="text" id="disp_direccion" readonly></div>
                        <div><label>AREA</label><input type="text" id="disp_area" readonly></div>
                        <div><label>VISITADOR</label><input type="text" id="disp_visitador" readonly></div>

                        <!-- CAPTURA (DATOS FALTANTES) -->
                        <div class="section-title" style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px;">
                            ‚¨á Captura de Datos
                        </div>

                        <div><label>TOTAL DE ALUMNOS</label><input type="number" id="field_total" required min="0"></div>
                        <div><label>ALUMNOS MUJER</label><input type="number" id="field_mujeres" required min="0"></div>
                        <div><label>ALUMNOS HOMBRES</label><input type="number" id="field_hombres" required min="0"></div>
                        <div><label>TOTAL DISCAPACIDAD</label><input type="number" id="field_discapacidad" required min="0"></div>
                        <div><label>MAYA HABLANTE</label><input type="number" id="field_maya" required min="0"></div>
                    </div>

                    <div class="actions">
                        <button type="submit" class="btn-save" id="btnSave">Guardar</button>
                        <!-- Bot√≥n Salir (Inicialmente oculto) -->
                        <button type="button" class="btn-logout hidden" id="btnLogout" onclick="logout()">Salir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="toast"></div>

       <script>
        // =====================================================
        // CONFIGURACI√ìN
        // =====================================================
        // Aseg√∫rate de que esta URL sea la de tu NUEVA implementaci√≥n
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdgT6vvVcv0dM06333cJbMSjUwcqFWxMcFSR0_ZGKeZwQjYn0P32F_-Lz3Pfs07zw_lA/exec";

        // =====================================================
        // L√ìGICA DE LOGIN (OBTIENE EL TOKEN)
        // =====================================================
        async function checkLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const btn = document.querySelector('#login-view button');
            const errorDiv = document.getElementById('login-error');

            btn.innerText = "Verificando...";
            btn.disabled = true;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    redirect: 'follow',
                    body: JSON.stringify({ action: 'login', user: user, pass: pass })
                });
                
                const rawText = await response.text();
                const data = JSON.parse(rawText);

                if (data.success) {
                    // üîë GUARDAMOS EL TOKEN DE SEGURIDAD
                    if(data.token) {
                        sessionStorage.setItem('authToken', data.token);
                    }
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showApp();
                } else {
                    errorDiv.innerText = data.message || "Error de acceso";
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                console.error(error);
                errorDiv.innerText = "Error de conexi√≥n con el servidor";
            } finally {
                btn.innerText = "Iniciar Sesi√≥n";
                btn.disabled = false;
            }
        }

        function showApp() {
            const loginView = document.getElementById('login-view');
            const appView = document.getElementById('app-view');
            
            if(loginView) loginView.style.display = 'none';
            if(appView) appView.classList.remove('hidden');
        }

        function logout() {
            // Al salir, limpiamos el token
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('isLoggedIn');
            location.reload(); 
        }

        window.addEventListener('DOMContentLoaded', () => {
            // Verificamos si hay un token guardado, no solo el flag de login
            if (sessionStorage.getItem('isLoggedIn') === 'true' && sessionStorage.getItem('authToken')) {
                showApp();
            }
            document.getElementById('password').addEventListener('keyup', e => { if(e.key==='Enter') checkLogin(); });
        });

        // =====================================================
        // L√ìGICA DE LA APP
        // =====================================================
        
        async function searchSchool() {
            const query = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('resultsList');
            const formSection = document.getElementById('formSection');

            if (!query) return alert("Por favor ingrese una clave CCT");

            formSection.classList.add('disabled'); 

            resultsDiv.innerHTML = '<div style="padding:15px; text-align:center;">Consultando base de datos...</div>';

            try {
                const response = await fetch(`${SCRIPT_URL}?q=${query}`, { redirect: 'follow' });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                if (!data || data.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding:15px;">No se encontraron escuelas con esa Clave CCT.</div>';
                    return;
                }

                let html = '<p style="margin-bottom:10px; color:#64748b;">Se encontraron resultados. Seleccione uno para capturar:</p>';
                data.forEach(row => {
                    html += `
                    <div class="result-item" onclick="selectSchool(${JSON.stringify(row).replace(/"/g, '&quot;')})">
                        <div class="result-header">
                            <div>
                                <strong>${row.nombre}</strong><br>
                                <small>${row.municipio}, ${row.localidad}</small>
                            </div>
                            <div style="text-align:right;">
                                <span class="cct-badge">${row.cct}</span><br>
                                <span class="turno-badge">${row.turno}</span>
                            </div>
                        </div>
                    </div>
                    `;
                });
                resultsDiv.innerHTML = html;

            } catch (error) {
                console.error(error);
                resultsDiv.innerHTML = `<p style="color:red; padding:15px;">Error: ${error.message}</p>`;
            }
        }

        function setFieldState(elementId, value) {
            const input = document.getElementById(elementId);
            if (value && value !== "" && value !== 0) {
                input.value = value;
                input.readOnly = true;
                input.classList.add('locked-field');
                return true;
            } else {
                input.value = "";
                input.readOnly = false;
                input.classList.remove('locked-field');
                return false;
            }
        }

        function selectSchool(data) {
            document.getElementById('rowIndex').value = data.rowIndex;
            document.getElementById('disp_num').value = data.num;
            document.getElementById('disp_cct').value = data.cct;
            document.getElementById('disp_nombre').value = data.nombre;
            document.getElementById('disp_nivel').value = data.nivel;
            document.getElementById('disp_turno').value = data.turno;
            document.getElementById('disp_municipio').value = data.municipio;
            document.getElementById('disp_localidad').value = data.localidad;
            document.getElementById('disp_direccion').value = data.direccion;
            document.getElementById('disp_area').value = data.area;
            document.getElementById('disp_visitador').value = data.visitador;

            const hasDataTotal = setFieldState('field_total', data.total);
            const hasDataMujeres = setFieldState('field_mujeres', data.mujeres);
            const hasDataHombres = setFieldState('field_hombres', data.hombres);
            const hasDataDisc = setFieldState('field_discapacidad', data.discapacidad);
            const hasDataMaya = setFieldState('field_maya', data.maya);

            const btnSave = document.getElementById('btnSave');
            const btnLogout = document.getElementById('btnLogout');

            if (hasDataTotal || hasDataMujeres || hasDataHombres || hasDataDisc || hasDataMaya) {
                btnSave.disabled = true;
                btnLogout.classList.remove('hidden');
            } else {
                btnSave.disabled = false;
                btnLogout.classList.add('hidden');
            }

            document.getElementById('formSection').classList.remove('disabled');
            document.getElementById('resultsList').innerHTML = ""; 
            
            const firstField = document.getElementById('field_total');
            if (!firstField.readOnly) firstField.focus();

            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function saveData() {
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Enviando datos...";

            // üîë RECUPERAMOS EL TOKEN
            const token = sessionStorage.getItem('authToken');

            const payload = {
                action: 'save',
                token: token, // üîë ENVIAMOS EL TOKEN PARA VALIDAR
                rowIndex: document.getElementById('rowIndex').value,
                total: document.getElementById('field_total').value,
                mujeres: document.getElementById('field_mujeres').value,
                hombres: document.getElementById('field_hombres').value,
                discapacidad: document.getElementById('field_discapacidad').value,
                maya: document.getElementById('field_maya').value
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    redirect: 'follow',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast("¬°Datos guardados correctamente!", "success");
                    
                    const currentData = {
                        rowIndex: payload.rowIndex,
                        num: document.getElementById('disp_num').value,
                        cct: document.getElementById('disp_cct').value,
                        nombre: document.getElementById('disp_nombre').value,
                        nivel: document.getElementById('disp_nivel').value,
                        turno: document.getElementById('disp_turno').value,
                        municipio: document.getElementById('disp_municipio').value,
                        localidad: document.getElementById('disp_localidad').value,
                        direccion: document.getElementById('disp_direccion').value,
                        area: document.getElementById('disp_area').value,
                        visitador: document.getElementById('disp_visitador').value,
                        total: payload.total,
                        mujeres: payload.mujeres,
                        hombres: payload.hombres,
                        discapacidad: payload.discapacidad,
                        maya: payload.maya
                    };
                    
                    selectSchool(currentData); 
                } else {
                    showToast("Error: " + (data.error || data.message), "error");
                    // Si el error es de sesi√≥n, forzamos logout
                    if(data.error && data.error.includes("Sesi√≥n inv√°lida")) {
                        setTimeout(() => logout(), 2000);
                    }
                    btn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                showToast("Error al guardar", "error");
                btn.disabled = false;
            } finally {
                if (!btn.disabled) btn.innerText = originalText;
            }
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = type === 'success' ? 'success show' : 'error show';
            setTimeout(() => t.className = type === 'success' ? 'success' : 'error', 3000);
        }
    </script>
</body>
</html>



